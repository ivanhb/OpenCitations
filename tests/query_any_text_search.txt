SELECT DISTINCT ?doc ?doi ?title ?year ?author ?author_iri (COUNT(distinct ?cited) AS ?num_cited)
WHERE  { 
  ?lit bds:search 'ESMO-ESGO-ESTRO' . 
  ?lit bds:matchAllTerms 'true' . 
  ?lit bds:relevance ?score .
  {?iri dcterms:title  ?lit } UNION {?iri fabio:hasSubtitle ?lit} UNION {?iri foaf:familyName ?lit} .
  
  OPTIONAL {
    ?iri rdf:type ?type .
    BIND(?iri as ?doc) .
    OPTIONAL {?doc dcterms:title  ?title .}
    OPTIONAL {?doc fabio:hasSubtitle  ?subtitle .}
    OPTIONAL {?doc fabio:hasPublicationYear ?year .}
    OPTIONAL {?doc cito:cites ?cited .}
    OPTIONAL {
    	?iri datacite:hasIdentifier [
    		datacite:usesIdentifierScheme datacite:doi ;
			literal:hasLiteralValue ?doi 
      	]
  	}
  
  	OPTIONAL {
         ?iri pro:isDocumentContextFor [
             pro:withRole pro:author ;
             pro:isHeldBy ?author_iri 
         ].
         ?author_iri foaf:familyName ?fname .
         ?author_iri foaf:givenName ?name .
         BIND(CONCAT(STR(?name),' ', STR(?fname)) as ?author) .
  	}
    
    FILTER regex(str(?iri), '^https://w3id.org/oc/corpus/br/')
  }
   
  OPTIONAL {
    ?iri rdf:type ?type .
	OPTIONAL{
      ?role pro:isHeldBy ?iri .
      ?doc pro:isDocumentContextFor ?role . 
      OPTIONAL {?doc dcterms:title ?title .}
      OPTIONAL {?doc fabio:hasSubtitle ?subtitle .}
      OPTIONAL {?doc fabio:hasPublicationYear ?year .}
      OPTIONAL {?doc cito:cites ?cited .}
      OPTIONAL {
          ?doc datacite:hasIdentifier [
              datacite:usesIdentifierScheme datacite:doi ;
              literal:hasLiteralValue ?doi 
          ]
      }

      OPTIONAL {
           ?doc pro:isDocumentContextFor [
               pro:withRole pro:author ;
               pro:isHeldBy ?author_iri 
           ].
           ?author_iri foaf:familyName ?fname .
           ?author_iri foaf:givenName ?name .
           BIND(CONCAT(STR(?name),' ', STR(?fname)) as ?author) .
      }
    }         
    FILTER regex(str(?iri), '^https://w3id.org/oc/corpus/ra/')
  } 
}GROUP BY ?doc ?doi ?title ?year ?author ?author_iri